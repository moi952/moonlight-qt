<!-- This block is autogenerated using scripts\update-msvcredist.ps1 -->
<?define VCREDIST_VER = "14.38.33135.0" ?>
<?define VCREDIST_X86_SIZE = "13853648" ?>
<?define VCREDIST_X86_SHA512 = "C08D1AA7E6E6215A0CEE2793592B65668066C8C984B26675D2B8C09BC7FEE21411CB3C0A905EAEE7A48E7A47535FA777DE21EEB07C78BCA7BF3D7BB17192ACF2" ?>
<?define VCREDIST_X86_URL = "https://download.visualstudio.microsoft.com/download/pr/71c6392f-8df5-4b61-8d50-dba6a525fb9d/510FC8C2112E2BC544FB29A72191EABCC68D3A5A7468D35D7694493BC8593A79/VC_redist.x86.exe" ?>
<?define VCREDIST_X86_UPGRADE_CODE = "65E5BD06-6392-3027-8C26-853107D3CF1A" ?>
<?define VCREDIST_X64_SIZE = "25416016" ?>
<?define VCREDIST_X64_SHA512 = "70A05BDE549E5A973397CD77FE0C6380807CAE768AA98454830F321A0DE64BD0DA30F31615AE6B4D9F0D244483A571E46024CF51B20FE813A6304A74BD8C0CC2" ?>
<?define VCREDIST_X64_URL = "https://download.visualstudio.microsoft.com/download/pr/c7707d68-d6ce-4479-973e-e2a3dc4341fe/1AD7988C17663CC742B01BEF1A6DF2ED1741173009579AD50A94434E54F56073/VC_redist.x64.exe" ?>
<?define VCREDIST_X64_UPGRADE_CODE = "36F68A90-239C-34DF-B58C-64B30153CE35" ?>
<?define VCREDIST_ARM64_SIZE = "11546568" ?>
<?define VCREDIST_ARM64_SHA512 = "2F4F78E51BE0048B8A086682DFFF0D92385182D5F940D4CA7E7ECDF3F2F85AABE4865812966A5CFBA31BAD1885B369C640A9F745C8A7B85CDDAA34B43D7FBC56" ?>
<?define VCREDIST_ARM64_URL = "https://download.visualstudio.microsoft.com/download/pr/71c6392f-8df5-4b61-8d50-dba6a525fb9d/9378E04AE461E29CE5E46787D20F81700C80AD305B9417710D147C1D7FF0C970/VC_redist.arm64.exe" ?>
<?define VCREDIST_ARM64_UPGRADE_CODE = "DC9BAE42-810B-423A-9E25-E4073F1C7B00" ?>

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:bal="http://wixtoolset.org/schemas/v4/wxs/bal" xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Bundle Name="Moonlight Game Streaming Client"
          Version="!(bind.PackageVersion.Moonlight_x64)"
          Manufacturer="Moonlight Game Streaming Project"
          UpgradeCode="466fa35d-4be4-40ef-9ce5-afadc3b63bc5"
          HelpUrl="https://github.com/moonlight-stream/moonlight-docs/wiki/Setup-Guide"
          UpdateUrl="https://github.com/moonlight-stream/moonlight-qt/releases"
          DisableModify="yes"
          IconSourceFile="..\..\app\moonlight.ico">

    <bal:Condition Message="Moonlight requires Windows 7 or later." Condition="VersionNT &gt;= v6.1" />

    <Variable Name="InstallFolder" Type="formatted" Value="[ProgramFiles6432Folder]Moonlight Game Streaming" />

    <!-- Define "Add desktop shortcut" -checkbox's state by defining a variable
         which has same name as the checkbox has. Value 1 means that checkbox
         is checked, 0 means that is unchecked-->
    <!-- Set checkbox's state as checked by default -->
    <Variable Name="AddDesktopShortcutCheckbox" Type="numeric" Value="1" />
    <!-- Get checkbox's state from registry if present. The registry value
         "DesktopShortcutInstallState" is set in Product.wxs. -->
    <util:RegistrySearch Variable="HasDesktopShortcutInstallStateRegKey" Root="HKCU" Key="Software\Moonlight Game Streaming Project" Value="DesktopShortcutInstallState" Result="exists" />
    <util:RegistrySearch Variable="AddDesktopShortcutCheckbox" Root="HKCU" Key="Software\Moonlight Game Streaming Project" Value="DesktopShortcutInstallState" Condition="HasDesktopShortcutInstallStateRegKey" />

    <util:ProductSearch Id="VCREDIST_14_x86"
                        UpgradeCode="$(var.VCREDIST_X86_UPGRADE_CODE)"
                        Result="version"
                        Variable="VCREDIST_14_x86" />

    <util:ProductSearch Id="VCREDIST_14_x64"
                        UpgradeCode="$(var.VCREDIST_X64_UPGRADE_CODE)"
                        Result="version"
                        Variable="VCREDIST_14_x64" />

    <util:ProductSearch Id="VCREDIST_14_ARM64"
                        UpgradeCode="$(var.VCREDIST_ARM64_UPGRADE_CODE)"
                        Result="version"
                        Variable="VCREDIST_14_ARM64" />

    <BootstrapperApplication>
      <bal:WixStandardBootstrapperApplication ShowVersion="yes"
                                              LicenseFile="license.rtf"
                                              LogoFile="..\..\app\moonlight_wix.png"
                                              LaunchTarget="[InstallFolder]\Moonlight.exe"
                                              ThemeFile="RtfTheme.xml"
                                              Theme="rtfLicense" />
    </BootstrapperApplication>

    <Chain>
      <ExePackage Cache="remove"
                  PerMachine="yes"
                  Permanent="yes"
                  Vital="yes"
                  InstallCondition="(NOT VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 332)"
                  DetectCondition="VCREDIST_14_x86 &gt;= v$(var.VCREDIST_VER)"
                  InstallArguments="/install /quiet /norestart">

        <ExePackagePayload Description="Microsoft Visual C++ 2015-2022 Redistributable - x86"
                           ProductName="Microsoft Visual C++ 2015-2022 Redistributable - x86"
                           Size="$(var.VCREDIST_X86_SIZE)"
                           Version="$(var.VCREDIST_VER)"
                           Hash="$(var.VCREDIST_X86_SHA512)"
                           Name="VC_redist.x86.exe"
                           DownloadUrl="$(var.VCREDIST_X86_URL)" />

        <!-- Newer version installed is fine -->
        <ExitCode Value="1638" Behavior="success" />
      </ExePackage>

      <ExePackage Cache="remove"
                  PerMachine="yes"
                  Permanent="yes"
                  Vital="yes"
                  InstallCondition="(VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 34404)"
                  DetectCondition="VCREDIST_14_x64 &gt;= v$(var.VCREDIST_VER)"
                  InstallArguments="/install /quiet /norestart">

        <ExePackagePayload Description="Microsoft Visual C++ 2015-2022 Redistributable - x64"
                           ProductName="Microsoft Visual C++ 2015-2022 Redistributable - x64"
                           Size="$(var.VCREDIST_X64_SIZE)"
                           Version="$(var.VCREDIST_VER)"
                           Hash="$(var.VCREDIST_X64_SHA512)"
                           Name="VC_redist.x64.exe"
                           DownloadUrl="$(var.VCREDIST_X64_URL)" />

        <!-- Newer version installed is fine -->
        <ExitCode Value="1638" Behavior="success" />
      </ExePackage>

      <ExePackage Cache="remove"
                  PerMachine="yes"
                  Permanent="yes"
                  Vital="yes"
                  InstallCondition="NativeMachine = 43620"
                  DetectCondition="VCREDIST_14_ARM64 &gt;= v$(var.VCREDIST_VER)"
                  InstallArguments="/install /quiet /norestart">

        <ExePackagePayload Description="Microsoft Visual C++ 2015-2022 Redistributable - ARM64"
                           ProductName="Microsoft Visual C++ 2015-2022 Redistributable - ARM64"
                           Size="$(var.VCREDIST_ARM64_SIZE)"
                           Version="$(var.VCREDIST_VER)"
                           Hash="$(var.VCREDIST_ARM64_SHA512)"
                           Name="VC_redist.arm64.exe"
                           DownloadUrl="$(var.VCREDIST_ARM64_URL)" />

        <!-- Newer version installed is fine -->
        <ExitCode Value="1638" Behavior="success" />
      </ExePackage>

      <MsiPackage Id="Moonlight_x86"
                  SourceFile="$(env.BUILD_ROOT)\build-x86-$(env.BUILD_CONFIG)\Moonlight.msi"
                  Name="Moonlight_x86.msi"
                  InstallCondition="(NOT VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 332)"
                  Vital="yes">
        <MsiProperty Name="INSTALLFOLDER" Value="[InstallFolder]" />
        <MsiProperty Name="ADDDESKTOPSHORTCUT" Value="[AddDesktopShortcutCheckbox]" />
      </MsiPackage>

      <MsiPackage Id="Moonlight_x64"
                  SourceFile="$(env.BUILD_ROOT)\build-x64-$(env.BUILD_CONFIG)\Moonlight.msi"
                  Name="Moonlight_x64.msi"
                  InstallCondition="(VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 34404)"
                  Vital="yes">
        <MsiProperty Name="INSTALLFOLDER" Value="[InstallFolder]" />
        <MsiProperty Name="ADDDESKTOPSHORTCUT" Value="[AddDesktopShortcutCheckbox]" />
      </MsiPackage>

      <MsiPackage Id="Moonlight_arm64"
                  SourceFile="$(env.BUILD_ROOT)\build-arm64-$(env.BUILD_CONFIG)\Moonlight.msi"
                  Name="Moonlight_arm64.msi"
                  InstallCondition="NativeMachine = 43620"
                  Vital="yes">
        <MsiProperty Name="INSTALLFOLDER" Value="[InstallFolder]" />
        <MsiProperty Name="ADDDESKTOPSHORTCUT" Value="[AddDesktopShortcutCheckbox]" />
      </MsiPackage>
    </Chain>

  </Bundle>
</Wix>
